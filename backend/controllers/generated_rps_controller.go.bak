package controllers

import (
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"strings"

	"github.com/gin-gonic/gin"
	"github.com/google/uuid"
	"github.com/lukasjarosch/go-docx"
	"github.com/syrlramadhan/dokumentasi-rps-api/models"
	"gorm.io/gorm"
)

type GeneratedRPSController struct {
	db *gorm.DB
}

func NewGeneratedRPSController(db *gorm.DB) *GeneratedRPSController {
	return &GeneratedRPSController{db: db}
}

// GetAll - Get all generated RPS
func (gc *GeneratedRPSController) GetAll(c *gin.Context) {
	var generatedRPS []models.GeneratedRPS
	var total int64

	// Count total
	gc.db.Model(&models.GeneratedRPS{}).Count(&total)

	if err := gc.db.Preload("Course").Preload("TemplateVersion").Preload("Generator").Find(&generatedRPS).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "Database error",
			"message": "Gagal mengambil data RPS",
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data": gin.H{
			"data": generatedRPS,
			"pagination": gin.H{
				"total_items":  total,
				"total_pages":  1,
				"current_page": 1,
				"per_page":     total,
			},
		},
	})
}

// Create - Create new RPS (initial record)
func (gc *GeneratedRPSController) Create(c *gin.Context) {
	var req struct {
		TemplateVersionID *string `json:"template_version_id"`
		CourseID          string  `json:"course_id" binding:"required"`
		GeneratedBy       *string `json:"generated_by"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// Parse CourseID
	courseUUID, err := uuid.Parse(req.CourseID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid course_id format"})
		return
	}

	// Check if course exists
	var course models.Course
	if err := gc.db.First(&course, "id = ?", courseUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "Course not found"})
		return
	}

	// Create GeneratedRPS
	rps := models.GeneratedRPS{
		CourseID: &courseUUID,
		Status:   "draft",
	}

	if req.TemplateVersionID != nil && *req.TemplateVersionID != "" {
		templateUUID, err := uuid.Parse(*req.TemplateVersionID)
		if err == nil {
			rps.TemplateVersionID = &templateUUID
		}
	}

	if req.GeneratedBy != nil && *req.GeneratedBy != "" {
		generatorUUID, err := uuid.Parse(*req.GeneratedBy)
		if err == nil {
			rps.GeneratedBy = &generatorUUID
		}
	}

	if err := gc.db.Create(&rps).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to create RPS"})
		return
	}

	// Load relationships
	gc.db.Preload("Course").Preload("TemplateVersion").Preload("Generator").First(&rps, "id = ?", rps.ID)

	c.JSON(http.StatusCreated, gin.H{
		"success": true,
		"data":    rps,
	})
}

// CreateDraft - Update RPS with result data (save draft)
func (gc *GeneratedRPSController) CreateDraft(c *gin.Context) {
	var req struct {
		JobID  string                 `json:"job_id" binding:"required"`
		Status string                 `json:"status"`
		Result map[string]interface{} `json:"result" binding:"required"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	jobUUID, err := uuid.Parse(req.JobID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid job_id format"})
		return
	}

	var rps models.GeneratedRPS
	if err := gc.db.First(&rps, "id = ?", jobUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "RPS not found"})
		return
	}

	// Update result and status
	updates := map[string]interface{}{
		"result": req.Result,
	}
	if req.Status != "" {
		updates["status"] = req.Status
	}

	if err := gc.db.Model(&rps).Updates(updates).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to update RPS"})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    rps,
	})
}

// Update - Update existing RPS
func (gc *GeneratedRPSController) Update(c *gin.Context) {
	id := c.Param("id")
	rpsUUID, err := uuid.Parse(id)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid ID format"})
		return
	}

	var rps models.GeneratedRPS
	if err := gc.db.First(&rps, "id = ?", rpsUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "RPS not found"})
		return
	}

	var req struct {
		Status string                 `json:"status"`
		Result map[string]interface{} `json:"result"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	updates := map[string]interface{}{}
	if req.Status != "" {
		updates["status"] = req.Status
	}
	if req.Result != nil {
		updates["result"] = req.Result
	}

	if err := gc.db.Model(&rps).Updates(updates).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to update RPS"})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    rps,
	})
}

// UpdateStatus - Update RPS status only
func (gc *GeneratedRPSController) UpdateStatus(c *gin.Context) {
	id := c.Param("id")
	rpsUUID, err := uuid.Parse(id)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid ID format"})
		return
	}

	var rps models.GeneratedRPS
	if err := gc.db.First(&rps, "id = ?", rpsUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "RPS not found"})
		return
	}

	var req struct {
		Status string `json:"status" binding:"required"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	if err := gc.db.Model(&rps).Update("status", req.Status).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to update status"})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "Status updated successfully",
	})
}

// Delete - Soft delete RPS
func (gc *GeneratedRPSController) Delete(c *gin.Context) {
	id := c.Param("id")
	rpsUUID, err := uuid.Parse(id)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid ID format"})
		return
	}

	var rps models.GeneratedRPS
	if err := gc.db.First(&rps, "id = ?", rpsUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "RPS not found"})
		return
	}

	if err := gc.db.Delete(&rps).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to delete RPS"})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "RPS deleted successfully",
	})
}

// Export - Export RPS to Word document using template
func (gc *GeneratedRPSController) Export(c *gin.Context) {
	id := c.Param("id")
	rpsUUID, err := uuid.Parse(id)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid ID format"})
		return
	}

	var rps models.GeneratedRPS
	if err := gc.db.Preload("Course").Preload("Course.Program").First(&rps, "id = ?", rpsUUID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "RPS not found"})
		return
	}

	// Parse result JSON
	var result map[string]interface{}
	if err := json.Unmarshal(rps.Result, &result); err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to parse RPS data"})
		return
	}

	// Load template
	templatePath := "templates/template_rps.docx"
	if _, err := os.Stat(templatePath); os.IsNotExist(err) {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Template file not found. Please place template_rps.docx in templates folder"})
		return
	}

	// Read template
	replaceMap := docx.PlaceholderMap{}

	// Basic Info
	replaceMap["{{KODE_MK}}"] = rps.Course.Code
	replaceMap["{{NAMA_MK}}"] = rps.Course.Title
	replaceMap["{{SKS}}"] = fmt.Sprintf("%d", rps.Course.Credits)
	if rps.Course.Program != nil {
		replaceMap["{{PROGRAM_STUDI}}"] = rps.Course.Program.Name
	}

	// CPMK
	cpmkText := ""
	if cpmkData, ok := result["cpmk"].([]interface{}); ok {
		for _, item := range cpmkData {
			if cpmk, ok := item.(map[string]interface{}); ok {
				code := getString(cpmk, "code")
				desc := getString(cpmk, "description")
				cpmkText += fmt.Sprintf("%s: %s\n", code, desc)
			}
		}
	}
	replaceMap["{{CPMK}}"] = cpmkText

	// Sub-CPMK
	subCPMKText := ""
	if subCPMKData, ok := result["subCPMK"].([]interface{}); ok {
		for i, item := range subCPMKData {
			if subCPMK, ok := item.(map[string]interface{}); ok {
				code := getString(subCPMK, "code")
				desc := getString(subCPMK, "description")
				subCPMKText += fmt.Sprintf("%d. %s: %s\n", i+1, code, desc)
			}
		}
	}
	replaceMap["{{SUB_CPMK}}"] = subCPMKText

	// Topik Pembelajaran
	topikText := ""
	if topikData, ok := result["topik"].([]interface{}); ok {
		for i, item := range topikData {
			if topik, ok := item.(map[string]interface{}); ok {
				topic := getString(topik, "topic")
				desc := getString(topik, "description")
				if topic != "" {
					topikText += fmt.Sprintf("Minggu %d: %s\n%s\n\n", i+1, topic, desc)
				}
			}
		}
	}
	replaceMap["{{TOPIK_PEMBELAJARAN}}"] = topikText

	// Tugas
	tugasText := ""
	if tugasData, ok := result["tugas"].([]interface{}); ok {
		for i, item := range tugasData {
			if tugas, ok := item.(map[string]interface{}); ok {
				judul := getString(tugas, "judul_tugas")
				if judul != "" {
					tugasText += fmt.Sprintf("TUGAS %d: %s\n", i+1, judul)
					tugasText += fmt.Sprintf("Sub-CPMK: %s\n", getString(tugas, "sub_cpmk"))
					tugasText += fmt.Sprintf("Indikator: %s\n", getString(tugas, "indikator"))
					tugasText += fmt.Sprintf("Batas Waktu: %s\n", getString(tugas, "batas_waktu"))
					tugasText += fmt.Sprintf("Petunjuk: %s\n", getString(tugas, "petunjuk_pengerjaan"))
					tugasText += fmt.Sprintf("Bobot: %v%%\n\n", tugas["bobot"])
				}
			}
		}
	}
	replaceMap["{{TUGAS}}"] = tugasText

	// Replace placeholders
	doc, err := docx.Open(templatePath)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to open template: " + err.Error()})
		return
	}
	defer doc.Close()

	if err := doc.ReplaceAll(replaceMap); err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to replace placeholders: " + err.Error()})
		return
	}

	// Write to buffer
	var buf bytes.Buffer
	if err := doc.Write(&buf); err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to write document: " + err.Error()})
		return
	}

	// Generate filename
	filename := fmt.Sprintf("RPS_%s_%s.docx", rps.Course.Code, rps.Course.Title)
	filename = strings.ReplaceAll(filename, " ", "_")

	// Set headers and send file
	c.Header("Content-Type", "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
	c.Header("Content-Disposition", fmt.Sprintf("attachment; filename=\"%s\"", filename))
	c.Data(http.StatusOK, "application/vnd.openxmlformats-officedocument.wordprocessingml.document", buf.Bytes())
}

// Helper function to safely get string from map
func getString(m map[string]interface{}, key string) string {
	if val, ok := m[key]; ok {
		if str, ok := val.(string); ok {
			return str
		}
	}
	return ""
}
	table := doc.AddTable()
	table.Properties().SetWidthPercent(100)

	// Header row - Blue background
	row := table.AddRow()
	cell := row.AddCell()
	cell.Properties().SetColumnSpan(2)
	para := cell.AddParagraph()
	run := para.AddRun()
	run.AddText("PERGURUAN TINGGI")
	run.Properties().SetBold(true)

	// Program Studi row
	row = table.AddRow()
	cell = row.AddCell()
	cell.Properties().SetColumnSpan(2)
	para = cell.AddParagraph()
	para.AddRun().AddText("PROGRAM STUDI")

	// Info table
	row = table.AddRow()
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("NAMA MATA KULIAH")
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText(rps.Course.Title)

	row = table.AddRow()
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("KODE MK")
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText(rps.Course.Code)

	row = table.AddRow()
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("RUMPUN MK")
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("")

	row = table.AddRow()
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("BOBOT (SKS)")
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText(fmt.Sprintf("%d", rps.Course.Credits))

	row = table.AddRow()
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("SEMESTER")
	cell = row.AddCell()
	cell.AddParagraph().AddRun().AddText("")

	doc.AddParagraph()

	// 2. CPL & CPMK Section
	para = doc.AddParagraph()
	run = para.AddRun()
	run.AddText("CAPAIAN PEMBELAJARAN LULUSAN YANG DIBEBANKAN PADA MK (CPL)")
	run.Properties().SetBold(true)

	doc.AddParagraph()

	// 3. CPMK Table
	para = doc.AddParagraph()
	run = para.AddRun()
	run.AddText("CAPAIAN PEMBELAJARAN MATA KULIAH (CPMK)")
	run.Properties().SetBold(true)

	if cpmkData, ok := result["cpmk"].([]interface{}); ok && len(cpmkData) > 0 {
		for _, item := range cpmkData {
			if cpmk, ok := item.(map[string]interface{}); ok {
				code := getString(cpmk, "code")
				desc := getString(cpmk, "description")
				doc.AddParagraph().AddRun().AddText(fmt.Sprintf("%s: %s", code, desc))
			}
		}
	}

	doc.AddParagraph()

	// 4. Sub-CPMK Section
	para = doc.AddParagraph()
	run = para.AddRun()
	run.AddText("KEMAMPUAN AKHIR TIAP TAHAPAN PEMBELAJARAN (Sub-CPMK)")
	run.Properties().SetBold(true)

	if subCPMKData, ok := result["subCPMK"].([]interface{}); ok && len(subCPMKData) > 0 {
		table = doc.AddTable()
		table.Properties().SetWidthPercent(100)

		// Header
		row = table.AddRow()
		row.AddCell().AddParagraph().AddRun().AddText("NOMOR")
		row.AddCell().AddParagraph().AddRun().AddText("Sub-CPMK")
		row.AddCell().AddParagraph().AddRun().AddText("Sub-CPMK#")

		for _, item := range subCPMKData {
			if subCPMK, ok := item.(map[string]interface{}); ok {
				row = table.AddRow()
				row.AddCell().AddParagraph().AddRun().AddText("")
				row.AddCell().AddParagraph().AddRun().AddText(getString(subCPMK, "code"))
				row.AddCell().AddParagraph().AddRun().AddText(getString(subCPMK, "description"))
			}
		}
	}

	doc.AddParagraph()

	// 5. RENCANA PEMBELAJARAN Table
	para = doc.AddParagraph()
	run = para.AddRun()
	run.AddText("RENCANA PEMBELAJARAN")
	run.Properties().SetBold(true)

	if topikData, ok := result["topik"].([]interface{}); ok && len(topikData) > 0 {
		table = doc.AddTable()
		table.Properties().SetWidthPercent(100)

		// Header
		row = table.AddRow()
		row.AddCell().AddParagraph().AddRun().AddText("MG KE")
		row.AddCell().AddParagraph().AddRun().AddText("KEMAMPUAN AKHIR")
		row.AddCell().AddParagraph().AddRun().AddText("INDIKATOR")
		row.AddCell().AddParagraph().AddRun().AddText("TOPIK & SUB-TOPIK MATERI")
		row.AddCell().AddParagraph().AddRun().AddText("METODE PEMBELAJARAN")
		row.AddCell().AddParagraph().AddRun().AddText("WAKTU (MENIT)")
		row.AddCell().AddParagraph().AddRun().AddText("TEKNIK & KRITERIA")
		row.AddCell().AddParagraph().AddRun().AddText("BOBOT (%)")

		for i, item := range topikData {
			if topik, ok := item.(map[string]interface{}); ok {
				topic := getString(topik, "topic")
				desc := getString(topik, "description")
				if topic != "" || desc != "" {
					row = table.AddRow()
					row.AddCell().AddParagraph().AddRun().AddText(fmt.Sprintf("%d", i+1))
					row.AddCell().AddParagraph().AddRun().AddText("")
					row.AddCell().AddParagraph().AddRun().AddText("")
					row.AddCell().AddParagraph().AddRun().AddText(topic + "\n" + desc)
					row.AddCell().AddParagraph().AddRun().AddText("")
					row.AddCell().AddParagraph().AddRun().AddText("")
					row.AddCell().AddParagraph().AddRun().AddText("")
					row.AddCell().AddParagraph().AddRun().AddText("")
				}
			}
		}
	}

	doc.AddParagraph()

	// 6. RENCANA TUGAS
	if tugasData, ok := result["tugas"].([]interface{}); ok && len(tugasData) > 0 {
		for tugasNo, item := range tugasData {
			if tugas, ok := item.(map[string]interface{}); ok {
				judul := getString(tugas, "judul_tugas")
				if judul != "" {
					para = doc.AddParagraph()
					run = para.AddRun()
					run.AddText(fmt.Sprintf("%d. RENCANA TUGAS %d", tugasNo+1, tugasNo+1))
					run.Properties().SetBold(true)

					table = doc.AddTable()
					table.Properties().SetWidthPercent(100)

					// Identitas
					row = table.AddRow()
					row.AddCell().AddParagraph().AddRun().AddText("Identitas Mata Kuliah")
					cell = row.AddCell()
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Nama MK: %s", rps.Course.Title))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Kode: %s", rps.Course.Code))

					row = table.AddRow()
					row.AddCell().AddParagraph().AddRun().AddText("Sub-CPMK & Indikator")
					cell = row.AddCell()
					cell.AddParagraph().AddRun().AddText(getString(tugas, "sub_cpmk"))
					cell.AddParagraph().AddRun().AddText(getString(tugas, "indikator"))

					row = table.AddRow()
					row.AddCell().AddParagraph().AddRun().AddText("Rencana Tugas")
					cell = row.AddCell()
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Judul Tugas: %s", judul))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Batas Waktu: %s", getString(tugas, "batas_waktu")))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Petunjuk: %s", getString(tugas, "petunjuk_pengerjaan")))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Luaran: %s", getString(tugas, "luaran_tugas")))

					row = table.AddRow()
					row.AddCell().AddParagraph().AddRun().AddText("Penilaian")
					cell = row.AddCell()
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Kriteria: %s", getString(tugas, "kriteria")))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Teknik: %s", getString(tugas, "teknik_penilaian")))
					cell.AddParagraph().AddRun().AddText(fmt.Sprintf("Bobot: %v%%", tugas["bobot"]))

					doc.AddParagraph()
				}
			}
		}
	}

	// Generate filename
	filename := fmt.Sprintf("RPS_%s_%s.docx", rps.Course.Code, rps.Course.Title)
	filename = strings.ReplaceAll(filename, " ", "_")

	// Set headers
	c.Header("Content-Type", "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
	c.Header("Content-Disposition", fmt.Sprintf("attachment; filename=\"%s\"", filename))

	// Write document to response
	if err := doc.Save(c.Writer); err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate document"})
		return
	}
}

// Helper function to safely get string from map
func getString(m map[string]interface{}, key string) string {
	if val, ok := m[key]; ok {
		if str, ok := val.(string); ok {
			return str
		}
	}
	return ""
}
